# åˆ é™¤è´¦æˆ·è¾¹ç¼˜å‡½æ•°ä½¿ç”¨æŒ‡å—

## âœ… éƒ¨ç½²çŠ¶æ€

**å‡½æ•°åç§°**: `delete-account`
**çŠ¶æ€**: ACTIVE âœ…
**ç‰ˆæœ¬**: 1
**JWT éªŒè¯**: å·²å¯ç”¨ âœ…

## ğŸ“ å‡½æ•° URL

```
https://acnriuoexalqvckiuvgr.supabase.co/functions/v1/delete-account
```

## ğŸ”§ åŠŸèƒ½è¯´æ˜

è¿™ä¸ªè¾¹ç¼˜å‡½æ•°ç”¨äºå®‰å…¨åœ°åˆ é™¤ç”¨æˆ·è´¦æˆ·ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **èº«ä»½éªŒè¯**: éªŒè¯è¯·æ±‚è€…çš„ JWT tokenï¼Œç¡®ä¿åªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„è´¦æˆ·
2. **å®‰å…¨åˆ é™¤**: ä½¿ç”¨ Supabase service_role key å®Œå…¨åˆ é™¤ç”¨æˆ·æ•°æ®
3. **è¯¦ç»†æ—¥å¿—**: åŒ…å«ä¸­æ–‡è°ƒè¯•æ—¥å¿—ï¼Œæ–¹ä¾¿è¿½è¸ªæ‰§è¡Œè¿‡ç¨‹
4. **CORS æ”¯æŒ**: æ”¯æŒè·¨åŸŸè¯·æ±‚ï¼Œå¯ä»ä»»ä½•å‰ç«¯åº”ç”¨è°ƒç”¨

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### åœ¨ Swift/iOS ä¸­è°ƒç”¨

```swift
import Supabase

func deleteAccount() async throws {
    // è·å–å½“å‰ç”¨æˆ·çš„ä¼šè¯
    let session = try await supabase.auth.session
    let accessToken = session.accessToken

    // è°ƒç”¨è¾¹ç¼˜å‡½æ•°
    let url = URL(string: "https://acnriuoexalqvckiuvgr.supabase.co/functions/v1/delete-account")!
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("Bearer \\(accessToken)", forHTTPHeaderField: "Authorization")
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")

    let (data, response) = try await URLSession.shared.data(for: request)

    guard let httpResponse = response as? HTTPURLResponse,
          httpResponse.statusCode == 200 else {
        throw NSError(domain: "DeleteAccount", code: -1, userInfo: nil)
    }

    let result = try JSONDecoder().decode(DeleteAccountResponse.self, from: data)
    print("âœ… \\(result.message)")

    // åˆ é™¤æˆåŠŸåç™»å‡º
    try await supabase.auth.signOut()
}

struct DeleteAccountResponse: Codable {
    let success: Bool
    let message: String
    let userId: String?
}
```

### åœ¨ JavaScript/TypeScript ä¸­è°ƒç”¨

```typescript
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  'https://acnriuoexalqvckiuvgr.supabase.co',
  'your-anon-key'
)

async function deleteAccount() {
  try {
    // è°ƒç”¨è¾¹ç¼˜å‡½æ•°
    const { data, error } = await supabase.functions.invoke('delete-account', {
      method: 'POST'
    })

    if (error) {
      console.error('âŒ åˆ é™¤å¤±è´¥:', error)
      return
    }

    console.log('âœ…', data.message)

    // åˆ é™¤æˆåŠŸåç™»å‡º
    await supabase.auth.signOut()
  } catch (err) {
    console.error('âŒ å‘ç”Ÿé”™è¯¯:', err)
  }
}
```

### ä½¿ç”¨ curl æµ‹è¯•

```bash
curl -X POST \\
  'https://acnriuoexalqvckiuvgr.supabase.co/functions/v1/delete-account' \\
  -H 'Authorization: Bearer YOUR_ACCESS_TOKEN' \\
  -H 'Content-Type: application/json'
```

## ğŸ“Š å“åº”æ ¼å¼

### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "message": "è´¦æˆ·å·²æˆåŠŸåˆ é™¤",
  "userId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

### é”™è¯¯å“åº”

#### 401 - æœªæä¾›è®¤è¯ä¿¡æ¯
```json
{
  "success": false,
  "message": "æœªæä¾›è®¤è¯ä¿¡æ¯"
}
```

#### 401 - è®¤è¯å¤±è´¥
```json
{
  "success": false,
  "message": "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•"
}
```

#### 405 - æ–¹æ³•ä¸å…è®¸
```json
{
  "success": false,
  "message": "åªæ”¯æŒ POST è¯·æ±‚"
}
```

#### 500 - æœåŠ¡å™¨é”™è¯¯
```json
{
  "success": false,
  "message": "åˆ é™¤è´¦æˆ·å¤±è´¥: [é”™è¯¯è¯¦æƒ…]"
}
```

## ğŸ” è°ƒè¯•æ—¥å¿—

å‡½æ•°æ‰§è¡Œæ—¶ä¼šè¾“å‡ºè¯¦ç»†çš„ä¸­æ–‡æ—¥å¿—ï¼ˆåœ¨ Supabase Dashboard çš„ Functions Logs ä¸­æŸ¥çœ‹ï¼‰ï¼š

```
ğŸ”µ å¼€å§‹å¤„ç†åˆ é™¤è´¦æˆ·è¯·æ±‚
ğŸ”µ æ­¥éª¤ 1: éªŒè¯ç”¨æˆ·èº«ä»½
âœ… ç”¨æˆ·èº«ä»½éªŒè¯æˆåŠŸï¼Œç”¨æˆ· ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ğŸ”µ æ­¥éª¤ 2: ä½¿ç”¨ç®¡ç†å‘˜æƒé™åˆ é™¤ç”¨æˆ·
âœ… ç”¨æˆ·è´¦æˆ·åˆ é™¤æˆåŠŸï¼Œç”¨æˆ· ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

å¦‚æœå‡ºç°é”™è¯¯ï¼š
```
âŒ é”™è¯¯: ç¼ºå°‘ Authorization header
âŒ é”™è¯¯: æ— æ•ˆçš„è®¤è¯ token
âŒ åˆ é™¤ç”¨æˆ·å¤±è´¥: [é”™è¯¯è¯¦æƒ…]
âŒ å‘ç”ŸæœªçŸ¥é”™è¯¯: [é”™è¯¯è¯¦æƒ…]
```

## âš ï¸ é‡è¦æç¤º

1. **ä¸å¯é€†æ“ä½œ**: åˆ é™¤è´¦æˆ·æ˜¯ä¸å¯é€†çš„æ“ä½œï¼Œè¯·åœ¨è°ƒç”¨å‰å‘ç”¨æˆ·æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
2. **è‡ªåŠ¨ç™»å‡º**: åˆ é™¤æˆåŠŸååº”è¯¥ç«‹å³è°ƒç”¨ `signOut()` ç™»å‡ºç”¨æˆ·
3. **æ•°æ®æ¸…ç†**: ç”¨æˆ·è´¦æˆ·åˆ é™¤åï¼Œç›¸å…³çš„æ•°æ®åº“è®°å½•å¯èƒ½éœ€è¦é€šè¿‡æ•°æ®åº“è§¦å‘å™¨æˆ– RLS ç­–ç•¥æ¥å¤„ç†
4. **æƒé™éªŒè¯**: å‡½æ•°å·²å¯ç”¨ JWT éªŒè¯ï¼Œç¡®ä¿ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·

## ğŸ“± åœ¨ Earthlord App ä¸­é›†æˆ

æ‚¨å¯ä»¥åœ¨ `ProfileTabView.swift` çš„é€€å‡ºç™»å½•æŒ‰é’®æ—è¾¹æ·»åŠ ä¸€ä¸ª"åˆ é™¤è´¦æˆ·"æŒ‰é’®ï¼š

```swift
// æ·»åŠ åˆ° ProfileTabView.swift
Button(action: {
    showDeleteAccountConfirm = true
}) {
    HStack(spacing: 8) {
        Image(systemName: "trash.fill")
            .font(.headline)

        Text("åˆ é™¤è´¦æˆ·")
            .font(.headline)
            .fontWeight(.semibold)
    }
    .foregroundColor(.white)
    .frame(maxWidth: .infinity)
    .frame(height: 50)
    .background(
        LinearGradient(
            colors: [
                Color(red: 0.8, green: 0.2, blue: 0.2),
                Color(red: 0.7, green: 0.1, blue: 0.1)
            ],
            startPoint: .leading,
            endPoint: .trailing
        )
    )
    .cornerRadius(25)
}
.padding(.horizontal, 20)
.padding(.top, 10)
.confirmationDialog(
    "ç¡®è®¤åˆ é™¤è´¦æˆ·",
    isPresented: $showDeleteAccountConfirm,
    titleVisibility: .visible
) {
    Button("æ°¸ä¹…åˆ é™¤è´¦æˆ·", role: .destructive) {
        Task {
            await deleteAccount()
        }
    }
    Button("å–æ¶ˆ", role: .cancel) {}
} message: {
    Text("æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‚¨çš„æ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚")
}
```

ç„¶ååœ¨ `AuthManager.swift` ä¸­æ·»åŠ åˆ é™¤è´¦æˆ·æ–¹æ³•ï¼š

```swift
func deleteAccount() async {
    isLoading = true
    errorMessage = nil

    do {
        // è·å–å½“å‰ä¼šè¯
        let session = try await supabase.auth.session

        // è°ƒç”¨è¾¹ç¼˜å‡½æ•°
        let response: DeleteAccountResponse = try await supabase.functions.invoke(
            "delete-account",
            options: FunctionInvokeOptions(
                method: .post
            )
        )

        print("âœ… \\(response.message)")

        // åˆ é™¤æˆåŠŸåç™»å‡º
        try await supabase.auth.signOut()

        currentUser = nil
        isAuthenticated = false

    } catch {
        errorMessage = "åˆ é™¤è´¦æˆ·å¤±è´¥: \\(error.localizedDescription)"
    }

    isLoading = false
}

struct DeleteAccountResponse: Codable {
    let success: Bool
    let message: String
    let userId: String?
}
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Supabase Edge Functions æ–‡æ¡£](https://supabase.com/docs/guides/functions)
- [Supabase Auth Admin API](https://supabase.com/docs/reference/javascript/auth-admin-deleteuser)
