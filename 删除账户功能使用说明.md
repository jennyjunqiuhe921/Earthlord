# 删除账户功能使用说明

## ✅ 实现完成

删除账户功能已成功集成到 Earthlord App 中！构建成功 ✅

## 📱 功能概览

### 1. 删除账户按钮
- **位置**: 个人页面（ProfileTabView）底部
- **样式**: 深红色渐变按钮，带有垃圾桶图标
- **位置顺序**: 退出登录按钮下方

### 2. 安全确认对话框
- **触发**: 点击"删除账户"按钮
- **验证方式**: 必须手动输入"删除"才能确认
- **警告提示**:
  - ❌ 此操作不可撤销
  - ❌ 您的所有数据将被永久删除
  - ❌ 删除后无法恢复账户

### 3. 删除流程
1. 用户点击"删除账户"按钮
2. 弹出确认对话框，显示警告信息
3. 用户必须在输入框中输入"删除"
4. 输入正确后，"确认删除账户"按钮才会启用
5. 点击确认后调用边缘函数删除账户
6. 删除成功后自动登出并显示成功提示

## 🔧 技术实现

### AuthManager.swift - deleteAccount() 方法

```swift
func deleteAccount() async -> Bool {
    print("🔴 开始删除账户流程")
    // 步骤 1: 获取用户会话
    // 步骤 2: 调用边缘函数删除账户
    // 步骤 3: 检查删除结果
    // 步骤 4: 清空本地认证状态
    print("✅ 删除账户流程完成")
}
```

**关键特性**:
- 使用 URLSession 直接调用 Supabase 边缘函数
- 包含完整的错误处理
- 详细的中文日志输出（🔴/✅/❌）
- 删除成功后自动清空本地状态

### ProfileTabView.swift - UI 组件

**新增组件**:
1. **删除账户按钮**
   - 深红色渐变背景
   - 红色边框突出显示
   - 垃圾桶图标

2. **DeleteAccountConfirmView** - 确认对话框
   - 大型警告图标
   - 三个警告提示
   - 输入验证（必须输入"删除"）
   - 实时边框颜色反馈
   - 启用/禁用按钮状态管理

3. **WarningText** - 警告文本组件
   - 统一的警告消息样式
   - 红色 X 标记图标

## 📊 调试日志

### 删除账户流程日志

```
🔴 用户确认删除账户
🔴 开始删除账户流程
🔴 步骤 1: 获取用户会话
✅ 获取会话成功，用户 ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
🔴 步骤 2: 调用边缘函数删除账户
🔴 步骤 3: 检查删除结果
📊 HTTP 状态码: 200
✅ 账户删除成功
✅ 账户已成功删除
🔴 步骤 4: 清空本地认证状态
✅ 删除账户流程完成
```

### 边缘函数日志（Supabase Dashboard）

```
🔵 开始处理删除账户请求
🔵 步骤 1: 验证用户身份
✅ 用户身份验证成功，用户 ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
🔵 步骤 2: 使用管理员权限删除用户
✅ 用户账户删除成功，用户 ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

### 取消删除日志

```
🔴 用户取消删除账户
```

### 错误处理日志

如果删除失败：
```
❌ 删除账户失败: [错误信息]
```

如果 JSON 解析失败：
```
❌ JSON 解析错误: [错误详情]
```

## 🎨 UI 设计

### 删除账户按钮样式
- **颜色**: 深红色渐变 (RGB: 0.6, 0.1, 0.1 → 0.5, 0.05, 0.05)
- **边框**: 红色描边 (RGB: 0.8, 0.1, 0.1)
- **高度**: 50pt
- **圆角**: 25pt
- **间距**: 退出登录按钮下方 10pt

### 确认对话框样式
- **背景**: 深灰色 (RGB: 0.1, 0.1, 0.1)
- **警告图标**: 70pt 红色三角形感叹号
- **输入框**:
  - 默认灰色边框
  - 输入"删除"后变为红色边框
  - 半透明白色背景

### 按钮状态
- **未输入"删除"**:
  - 按钮半透明 (opacity: 0.5)
  - 按钮禁用
- **已输入"删除"**:
  - 按钮完全不透明 (opacity: 1.0)
  - 按钮启用

## 📁 修改的文件

### 1. Earthlord/AuthManager.swift
- ✅ 添加 `deleteAccount()` 方法（第 424-509 行）
- ✅ 添加 `DeleteAccountResponse` 结构体
- ✅ 包含详细的中文日志

### 2. Earthlord/Views/Tabs/ProfileTabView.swift
- ✅ 添加状态变量（第 18-25 行）
- ✅ 添加删除账户按钮（第 185-218 行）
- ✅ 添加确认对话框 sheet（第 248-263 行）
- ✅ 添加 `DeleteAccountConfirmView` 组件（第 343-472 行）
- ✅ 添加 `WarningText` 组件（第 474-493 行）

## 🔗 API 调用

### 边缘函数端点
```
https://acnriuoexalqvckiuvgr.supabase.co/functions/v1/delete-account
```

### 请求方式
- **Method**: POST
- **Headers**:
  - `Authorization`: Bearer {access_token}
  - `Content-Type`: application/json

### 响应格式
```json
{
  "success": true,
  "message": "账户已成功删除",
  "userId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

## ⚠️ 安全提示

1. **不可逆操作**: 账户删除后无法恢复
2. **数据清除**: 所有用户数据将被永久删除
3. **会话终止**: 删除成功后自动登出
4. **输入验证**: 必须准确输入"删除"才能确认

## 🧪 测试步骤

1. 运行 App 并登录
2. 进入个人页面（ProfileTabView）
3. 滚动到底部，找到"删除账户"按钮
4. 点击按钮，查看确认对话框
5. 尝试不输入任何内容点击确认（应该是禁用状态）
6. 输入"删除"，观察按钮变为可用状态
7. 点击"确认删除账户"
8. 查看 Xcode 控制台的日志输出
9. 确认删除成功后自动返回登录页面

## 📝 注意事项

- 删除账户功能只在用户已登录时可用
- 输入验证区分大小写，必须输入"删除"（不是"删 除"或"Delete"）
- 删除过程中会显示加载指示器
- 如果删除失败，会显示错误消息，用户仍保持登录状态
- 边缘函数会自动验证 JWT token，确保只能删除自己的账户

## 🎉 功能完成

删除账户功能已完全集成到 Earthlord App 中，包括：
- ✅ UI 组件（按钮、对话框）
- ✅ 输入验证
- ✅ API 调用
- ✅ 错误处理
- ✅ 日志记录
- ✅ 状态管理
- ✅ 构建成功

可以立即使用！🚀
